<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Affluents de la Seine par longueur (Wikidata)</title>
  <style>
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.5rem;
      background: #f5f5f5;
      color: #222;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.5rem;
    }

    p {
      margin-top: 0;
      margin-bottom: 0.75rem;
    }

    .card {
      max-width: 1100px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
    }

    .status {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 0.75rem;
      min-height: 1.2em;
    }

    .status.error {
      color: #b00020;
      font-weight: 600;
    }

    .chart-wrapper {
      margin-top: 0.5rem;
      max-height: 600px;
      overflow-y: auto;
      padding-right: 0.5rem;
    }

    .row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 6px;
      font-size: 0.85rem;
    }

    .row-label {
      flex: 0 0 220px;
      text-align: right;
      padding-right: 0.5rem;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .row-bar-container {
      flex: 1;
      background: #eee;
      border-radius: 999px;
      overflow: hidden;
      position: relative;
      height: 24px;
    }

    .row-bar {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #4a90e2, #2c6cb0);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      cursor: pointer;
      position: relative;
    }

    .row-bar:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }

    .row-value {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8rem;
      font-weight: 500;
      white-space: nowrap;
      pointer-events: none;
    }

    /* Cas 1 : barre longue → texte dedans (blanc sur bleu) */
    .row-value.inside {
      right: 8px;
      color: #fff;
      text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    }

    /* Cas 2 : barre courte → texte à l'extérieur, juste après la barre bleue */
    .row-value.outside {
      color: #222;
      text-shadow: none;
    }

    .footer-note {
      margin-top: 0.75rem;
      font-size: 0.75rem;
      color: #777;
    }

    @media (max-width: 700px) {
      .row-label {
        flex: 0 0 140px;
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Affluents de la Seine par longueur (km)</h1>
    <p>
      Source: <a href="https://wikidata.org">Wikidata</a>. 
    </p>

    <div id="status" class="status">Chargement des données depuis Wikidata…</div>

    <div class="chart-wrapper" id="chart"></div>

    <div class="footer-note">
      Source : Wikidata – propriété longueur de cours d’eau (P2043), embouchure (P403) = Seine (Q1471).
    </div>
  </div>

  <script>
    const endpoint = "https://query.wikidata.org/sparql";

    // Q1471 = Seine
    const query = `
      SELECT ?river ?riverLabel ?length
      WHERE {
        ?river wdt:P403 wd:Q1471 ;  # embouchure = Seine
               wdt:P2043 ?length .  # longueur (en km)
        SERVICE wikibase:label {
          bd:serviceParam wikibase:language "fr,en".
        }
      }
      ORDER BY DESC(?length)
    `;

    const statusEl = document.getElementById("status");
    const chartEl = document.getElementById("chart");

    async function loadData() {
      try {
        const url = endpoint + "?query=" + encodeURIComponent(query);
        const response = await fetch(url, {
          headers: { "Accept": "application/sparql-results+json" }
        });

        if (!response.ok) {
          throw new Error("Erreur réseau (" + response.status + ")");
        }

        const json = await response.json();

        const data = json.results.bindings.map(b => ({
          name: b.riverLabel?.value || "(sans nom)",
          km: parseFloat(b.length.value)
        }));

        if (!data.length) {
          statusEl.textContent = "Aucun affluent trouvé.";
          return;
        }

        // tri décroissant
        data.sort((a, b) => b.km - a.km);

        const max = Math.max(...data.map(d => d.km));

        statusEl.textContent = data.length + " affluents trouvés.";

        chartEl.innerHTML = "";

        // On crée d'abord toutes les lignes, puis on ajuste le placement du texte après le rendu
        const rows = [];
        data.forEach(d => {
          const row = document.createElement("div");
          row.className = "row";

          const label = document.createElement("div");
          label.className = "row-label";
          label.textContent = d.name;

          const barContainer = document.createElement("div");
          barContainer.className = "row-bar-container";

          const bar = document.createElement("div");
          bar.className = "row-bar";
          const widthPercent = (d.km / max) * 100;
          bar.style.width = widthPercent + "%";
          bar.title = `${d.name} – ${d.km.toFixed(1)} km`;

          const value = document.createElement("span");
          value.className = "row-value";
          value.textContent = Math.round(d.km);

          barContainer.appendChild(bar);
          row.appendChild(label);
          row.appendChild(barContainer);
          chartEl.appendChild(row);
          rows.push({ row, bar, value, barContainer });
        });

        // Après le rendu, on ajuste le placement du texte
        rows.forEach(({ bar, value, barContainer }) => {
          // Largeur réelle de la barre et du texte
          const barRect = bar.getBoundingClientRect();
          const valueRect = value.getBoundingClientRect();

          // Si le texte tient dans la barre (avec une marge de 16px), on le met à l'intérieur de la barre bleue
          if (barRect.width >= valueRect.width + 16 + 40) {
            value.classList.add("inside");
            bar.appendChild(value); // Le label est dans la barre bleue
          } else {
            // Sinon, on le met juste après la barre bleue
            value.classList.add("outside");
            value.style.left = barRect.width + 8 + "px";
            barContainer.appendChild(value); // Le label est dans le conteneur gris
          }
        });

      } catch (e) {
        console.error(e);
        statusEl.textContent = "Erreur lors du chargement des données Wikidata.";
        statusEl.classList.add("error");
      }
    }

    loadData();
  </script>
</body>
</html>
